<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Algorate Admin - Data Imports</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .header h1 {
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .header p {
            color: #7f8c8d;
        }
        
        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .card h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }
        
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #2980b9;
        }
        
        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        
        .btn-success {
            background: #27ae60;
        }
        
        .btn-success:hover {
            background: #229954;
        }
        
        .btn-warning {
            background: #f39c12;
        }
        
        .btn-warning:hover {
            background: #e67e22;
        }
        
        .status-card {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .status-item {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        
        .status-item h3 {
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .status-item p {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .status-running {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }
        
        .status-completed {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }
        
        .status-failed {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
        }
        
        .logs-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .log-entry {
            padding: 10px;
            border-bottom: 1px solid #eee;
            font-family: monospace;
            font-size: 12px;
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .log-success {
            background: #d4edda;
        }
        
        .log-error {
            background: #f8d7da;
        }
        
        .log-info {
            background: #d1ecf1;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .input-group input {
            width: 200px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .loading {
            display: none;
            color: #3498db;
            font-style: italic;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .status-card {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Algorate Admin Dashboard</h1>
            <p>Data Import Management System</p>
        </div>
        
        <!-- Import Controls -->
        <div class="card">
            <h2>Meetings Import</h2>
            
            <div class="input-group">
                <label for="import-date">Import Date (DD/MM/YYYY):</label>
                <input type="text" id="import-date" placeholder="26/08/2025" />
                <small style="color: #7f8c8d; margin-left: 10px;">Leave empty for tomorrow's meetings</small>
            </div>
            
            <button class="btn btn-success" onclick="runImport()">Run Import Now</button>
            <button class="btn btn-warning" onclick="testConnection()">Test API Connection</button>
            <button class="btn" onclick="refreshStatus()">Refresh Status</button>
            <button class="btn" onclick="clearTestData()" style="background: #e74c3c;">Clear Test Data</button>
            
            <div class="loading" id="loading">Processing...</div>
            <div class="error-message" id="error-message"></div>
            <div class="success-message" id="success-message"></div>
        </div>
        
        <!-- Status Display -->
        <div class="card">
            <h2>Import Status</h2>
            <div class="status-card" id="status-display">
                <div class="status-item">
                    <h3>Last Run</h3>
                    <p id="last-run">Loading...</p>
                </div>
                <div class="status-item">
                    <h3>Status</h3>
                    <p id="status">Loading...</p>
                </div>
                <div class="status-item">
                    <h3>Trigger Type</h3>
                    <p id="trigger-type">Loading...</p>
                </div>
                <div class="status-item">
                    <h3>Records Processed</h3>
                    <p id="records-processed">Loading...</p>
                </div>
            </div>
        </div>
        
        <!-- Import Logs -->
        <div class="card">
            <h2>Recent Import Logs</h2>
            <div class="logs-container" id="logs-container">
                <div class="log-entry">Loading logs...</div>
            </div>
        </div>
    </div>

    <script>
        // API base URL
        const API_BASE = '/api';
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            refreshStatus();
            loadLogs();
            
            // Set tomorrow's date as default
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const defaultDate = tomorrow.toLocaleDateString('en-AU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
            document.getElementById('import-date').value = defaultDate;
        });
        
        // Show/hide loading state
        function setLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
            document.querySelectorAll('.btn').forEach(btn => btn.disabled = show);
        }
        
        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => errorDiv.style.display = 'none', 5000);
        }
        
        // Show success message
        function showSuccess(message) {
            const successDiv = document.getElementById('success-message');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => successDiv.style.display = 'none', 5000);
        }
        
        // Run manual import
        async function runImport() {
            const dateInput = document.getElementById('import-date').value;
            
            setLoading(true);
            
            try {
                const payload = dateInput ? { date: dateInput } : {};
                
                const response = await fetch(`${API_BASE}/import/meetings`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess(result.message);
                    refreshStatus();
                    loadLogs();
                } else {
                    showError(result.error || 'Import failed');
                }
            } catch (error) {
                showError('Network error: ' + error.message);
            } finally {
                setLoading(false);
            }
        }
        
        // Test API connection
        async function testConnection() {
            const dateInput = document.getElementById('import-date').value;
            
            setLoading(true);
            
            try {
                let url = `${API_BASE}/import/meetings/test`;
                let options = {
                    method: 'GET'
                };
                
                if (dateInput) {
                    // Send as POST with JSON payload if date is provided
                    url = `${API_BASE}/import/meetings/test`;
                    options = {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ date: dateInput })
                    };
                }
                
                const response = await fetch(url, options);
                const result = await response.json();
                
                if (result.success) {
                    showSuccess(result.message);
                } else {
                    showError(result.error || 'Connection test failed');
                }
            } catch (error) {
                showError('Network error: ' + error.message);
            } finally {
                setLoading(false);
            }
        }
        
        // Refresh status display
        async function refreshStatus() {
            try {
                const response = await fetch(`${API_BASE}/import/meetings/status`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    const data = result.data;
                    
                    document.getElementById('last-run').textContent = data.started_at || 'Never';
                    document.getElementById('status').textContent = data.status || 'Unknown';
                    document.getElementById('trigger-type').textContent = data.trigger_type || 'N/A';
                    document.getElementById('records-processed').textContent = data.records_processed || '0';
                    
                    // Update status styling
                    const statusDisplay = document.getElementById('status-display');
                    statusDisplay.className = 'status-card';
                    if (data.status === 'running') {
                        statusDisplay.classList.add('status-running');
                    } else if (data.status === 'completed') {
                        statusDisplay.classList.add('status-completed');
                    } else if (data.status === 'failed') {
                        statusDisplay.classList.add('status-failed');
                    }
                } else {
                    document.getElementById('last-run').textContent = 'Never';
                    document.getElementById('status').textContent = 'Unknown';
                    document.getElementById('trigger-type').textContent = 'N/A';
                    document.getElementById('records-processed').textContent = '0';
                }
            } catch (error) {
                console.error('Failed to refresh status:', error);
            }
        }
        
        // Load import logs
        async function loadLogs() {
            try {
                const response = await fetch(`${API_BASE}/import/meetings/logs?per_page=10`);
                const result = await response.json();
                
                const logsContainer = document.getElementById('logs-container');
                
                if (result.success && result.data.logs.length > 0) {
                    logsContainer.innerHTML = '';
                    
                    result.data.logs.forEach(log => {
                        const logEntry = document.createElement('div');
                        logEntry.className = 'log-entry';
                        
                        if (log.status === 'completed') {
                            logEntry.classList.add('log-success');
                        } else if (log.status === 'failed') {
                            logEntry.classList.add('log-error');
                        } else {
                            logEntry.classList.add('log-info');
                        }
                        
                        const message = log.error_message || log.message || 'No message';
                        logEntry.innerHTML = `
                            <strong>${log.started_at}</strong> - ${log.trigger_type.toUpperCase()} - ${log.status.toUpperCase()}<br>
                            Target Date: ${log.target_date || 'N/A'} | Processed: ${log.records_processed || 0} | Inserted: ${log.records_inserted || 0} | Updated: ${log.records_updated || 0}<br>
                            ${message}
                        `;
                        
                        logsContainer.appendChild(logEntry);
                    });
                } else {
                    logsContainer.innerHTML = '<div class="log-entry">No import logs found</div>';
                }
            } catch (error) {
                console.error('Failed to load logs:', error);
                document.getElementById('logs-container').innerHTML = '<div class="log-entry log-error">Failed to load logs</div>';
            }
        }
        
        async function clearTestData() {
            if (!confirm('Are you sure you want to clear all test data? This will delete all meetings and import logs.')) {
                return;
            }
            
            showLoading();
            hideMessages();
            
            try {
                const response = await fetch('/api/admin/clear-test-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        clear_meetings: true,
                        clear_logs: true
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess(`Test data cleared successfully. ${JSON.stringify(data.results)}`);
                    refreshStatus(); // Refresh to show empty state
                } else {
                    showError(data.error || 'Failed to clear test data');
                }
            } catch (error) {
                showError('Network error: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // Auto-refresh status every 30 seconds
        setInterval(refreshStatus, 30000);
    </script>
</body>
</html>